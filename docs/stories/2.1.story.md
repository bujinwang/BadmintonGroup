# Story 2.1: Permission System Implementation - Brownfield Addition

## Status: Draft

## Story

As a session organizer,
I want role-based access control that distinguishes me from regular players,
So that I can manage the session while players have appropriate limited access.

## Context Source

- Source Document: docs/prd.md (Phase 2 permission system requirements)
- Enhancement Type: Security and access control feature
- Existing System Impact: Adds permission layer to existing session and player management

## Acceptance Criteria

**Functional Requirements:**

1. **Role Assignment**: System automatically assigns "organizer" role to session creator and "player" role to all others
2. **Permission Enforcement**: Backend API endpoints enforce role-based access control
3. **UI Permission Controls**: Frontend shows/hides features based on user role
4. **Session Management Permissions**: Only organizer can edit session details, delete session, manage players
5. **Player Permissions**: Players can view session info, update their own status, leave session
6. **Permission Error Handling**: Clear error messages when users attempt unauthorized actions
7. **Role Persistence**: User roles maintained across app sessions and device changes

**Integration Requirements:**

8. **Existing API Compatibility**: Permission checks integrate with existing API endpoints without breaking changes
9. **Database Extensions**: Role information stored in existing player/session models
10. **Real-time Updates**: Permission changes reflected immediately across all connected devices
11. **Authentication Integration**: Roles work with future authentication system (extensible design)

**Quality Requirements:**

12. **Security Testing**: Permission bypass attempts properly rejected
13. **Performance Impact**: Permission checks add minimal latency (<50ms)
14. **Test Coverage**: Unit tests for permission logic, integration tests for role enforcement
15. **Documentation**: Permission matrix documented for future reference
16. **Audit Trail**: Permission decisions logged for debugging

**Non-Functional Requirements:**

17. **Scalability**: Permission system supports future role types without major changes
18. **User Experience**: Permission restrictions explained clearly without frustration
19. **Accessibility**: Permission-based UI changes maintain accessibility standards
20. **Internationalization**: Permission error messages support multiple languages

## Dev Technical Guidance

### Existing System Context

Current system has session and player models from Epic 1. Existing patterns include middleware usage and role-based UI rendering.

### Integration Approach

Add role field to player model, create permission middleware, update frontend components with conditional rendering based on roles.

### Technical Constraints

- Must work with existing no-authentication MVP approach
- Roles determined by session creation (first user = organizer)
- Permission checks must be lightweight and fast
- Future authentication system compatibility required

### Missing Information

- Exact permission matrix for all operations
- UI component visibility rules
- Error message content and tone
- Role transition scenarios

### Tasks / Subtasks

- [ ] Task 1: Extend data models for roles
  - [ ] Add role field to player model
  - [ ] Update Prisma schema with role enum
  - [ ] Create database migration
  - [ ] Update existing player creation logic

- [ ] Task 2: Implement permission middleware
  - [ ] Create role-checking middleware
  - [ ] Define permission matrix for all operations
  - [ ] Add middleware to protected API routes
  - [ ] Implement permission error responses

- [ ] Task 3: Update frontend role detection
  - [ ] Add role detection logic to session joining
  - [ ] Store user role in app state
  - [ ] Update session context with role information
  - [ ] Handle role changes in real-time

- [ ] Task 4: Implement UI permission controls
  - [ ] Add conditional rendering based on roles
  - [ ] Hide/show organizer-only features
  - [ ] Update player-only UI elements
  - [ ] Add permission error feedback

- [ ] Task 5: Add permission validation
  - [ ] Client-side permission checks
  - [ ] Server-side validation
  - [ ] Comprehensive error handling
  - [ ] Permission bypass prevention

- [ ] Task 6: Update real-time communication
  - [ ] Include role information in socket events
  - [ ] Handle permission-based event filtering
  - [ ] Update real-time UI based on permissions
  - [ ] Test permission changes across devices

- [ ] Task 7: Add tests and documentation
  - [ ] Unit tests for permission logic
  - [ ] Integration tests for role enforcement
  - [ ] Permission matrix documentation
  - [ ] User guide for role-based features

## Testing

### Validation Steps

1. Create session as organizer (verify organizer role assigned)
2. Join session as player (verify player role assigned)
3. Test organizer permissions (edit session, manage players)
4. Test player permissions (view only, update own status)
5. Attempt permission violations (verify rejection)
6. Test real-time permission updates
7. Verify role persistence across app restarts

### Test Scenarios

- Valid role assignment for organizer and players
- Permission enforcement for all protected operations
- UI element visibility based on roles
- Error handling for unauthorized actions
- Real-time permission synchronization
- Role persistence across sessions

## Dev Notes

### File Structure Impact

New files to be created:
- backend/src/middleware/permissions.ts
- backend/src/utils/permissions.ts
- frontend/src/hooks/usePermissions.ts
- frontend/src/components/PermissionGuard.tsx

Modified files:
- backend/prisma/schema.prisma
- backend/src/models/Player.ts
- backend/src/routes/sessions.ts
- backend/src/routes/players.ts
- frontend/src/contexts/SessionContext.tsx
- frontend/src/components/SessionDetails.tsx

### Permission Matrix

| Operation | Organizer | Player |
|-----------|-----------|--------|
| View session | ✅ | ✅ |
| Edit session | ✅ | ❌ |
| Delete session | ✅ | ❌ |
| Add players | ✅ | ❌ |
| Remove players | ✅ | ❌ |
| Update own status | ✅ | ✅ |
| Leave session | ✅ | ✅ |
| View all players | ✅ | ✅ |

### API Contracts

Permission Error Response:
```json
{
  "error": "Insufficient permissions",
  "requiredRole": "organizer",
  "userRole": "player",
  "operation": "edit_session"
}
```

Role Information in Session Data:
```json
{
  "session": { ... },
  "players": [
    {
      "id": "player1",
      "name": "John",
      "role": "organizer"
    },
    {
      "id": "player2",
      "name": "Jane",
      "role": "player"
    }
  ],
  "currentUserRole": "player"
}
```

### UI Permission Patterns

```typescript
// Conditional rendering
{userRole === 'organizer' && (
  <EditSessionButton />
)}

// Permission guard component
<PermissionGuard requiredRole="organizer">
  <ManagePlayersSection />
</PermissionGuard>
```

## Definition of Done

- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Risk Assessment

**Minimal Risk Assessment:**

- **Primary Risk:** Permission system could break existing user flows
- **Mitigation:** Implement with feature flags, comprehensive testing
- **Rollback:** Permission checks can be disabled by removing middleware

**Compatibility Verification:**

- [ ] No breaking changes to existing API responses
- [ ] Database migration is backward compatible
- [ ] UI changes are progressive (features appear, don't break)
- [ ] Performance impact is negligible