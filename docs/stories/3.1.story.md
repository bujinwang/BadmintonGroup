# Story 3.1: Session Discovery and Management - Brownfield Addition

## Status: Done

## Story

As a badminton enthusiast,
I want to discover and join active sessions in my area,
So that I can easily find and participate in games without knowing specific session links.

## Context Source

- Source Document: docs/prd.md (Phase 3 session system requirements)
- Enhancement Type: Discovery and session lifecycle feature
- Existing System Impact: Extends session management with discovery and advanced configuration

## Acceptance Criteria

**Functional Requirements:**

1. **Session Discovery**: Browse active sessions by location, time, and skill level
2. **Search and Filters**: Search sessions by location, date/time, player count, skill level
3. **Session Details**: View comprehensive session information before joining
4. **Advanced Configuration**: Organizers can set detailed session preferences (skill requirements, court type, etc.)
5. **Session Persistence**: Sessions remain discoverable until explicitly ended
6. **Real-time Availability**: Session availability updates in real-time across all users
7. **Join from Discovery**: One-click join from discovery results

**Integration Requirements:**

8. **Existing Session Integration**: Discovery works with existing session creation and joining
9. **Permission Integration**: Respects organizer permissions for session visibility
10. **Real-time Updates**: Session status changes reflected in discovery immediately
11. **Location Services**: Integrates with device location for local session discovery

**Quality Requirements:**

12. **Performance**: Discovery results load within 2 seconds
13. **Relevance**: Sessions sorted by relevance (distance, time, skill match)
14. **Privacy**: Session visibility controlled by organizer preferences
15. **Caching**: Frequent discovery queries cached for performance
16. **Error Handling**: Graceful handling of network issues and empty results

**Non-Functional Requirements:**

17. **Scalability**: Discovery system supports 1000+ concurrent active sessions
18. **Usability**: Intuitive search and filter interface
19. **Accessibility**: Discovery features work with screen readers
20. **Cross-Platform**: Consistent experience on iOS and Android

## Dev Technical Guidance

### Existing System Context

Current system has basic session creation and joining from Epic 1. Existing patterns include API service layers and real-time updates.

### Integration Approach

Add session discovery API endpoints, extend session model with discovery fields, create discovery UI, integrate with existing session lifecycle.

### Technical Constraints

- Must work with existing no-authentication MVP
- Location-based discovery requires proper permissions
- Real-time updates mandatory for session availability
- Performance critical for good user experience

### Missing Information

- Location permission handling
- Session visibility rules
- Search ranking algorithm
- Caching strategy details

### Tasks / Subtasks

- [ ] Task 1: Extend session model for discovery
  - [ ] Add discovery fields to session model
  - [ ] Add location and skill level fields
  - [ ] Update Prisma schema
  - [ ] Create database migration

- [ ] Task 2: Implement discovery API
  - [ ] Create GET /api/sessions/discovery endpoint
  - [ ] Add search and filter parameters
  - [ ] Implement location-based filtering
  - [ ] Add relevance sorting

- [ ] Task 3: Build discovery UI
  - [ ] Create SessionDiscoveryScreen component
  - [ ] Add search and filter controls
  - [ ] Implement session list with details
  - [ ] Add location permission handling

- [ ] Task 4: Add advanced session configuration
  - [ ] Extend session creation with advanced options
  - [ ] Add skill level and court type settings
  - [ ] Implement session visibility controls
  - [ ] Add session duration and recurrence options

- [ ] Task 5: Implement caching and performance
  - [ ] Add Redis caching for discovery queries
  - [ ] Implement cache invalidation for session changes
  - [ ] Add database indexes for search performance
  - [ ] Optimize query performance

- [ ] Task 6: Add real-time discovery updates
  - [ ] Emit session creation/update events
  - [ ] Update discovery results in real-time
  - [ ] Handle session ending and cleanup
  - [ ] Implement optimistic updates

- [ ] Task 7: Comprehensive testing
  - [ ] Unit tests for discovery algorithm
  - [ ] Integration tests for search and filters
  - [ ] UI tests for discovery interface
  - [ ] Performance tests for large datasets

## Testing

### Validation Steps

1. Create multiple sessions with different locations and times
2. Search for sessions by location and time
3. Apply filters for skill level and player count
4. Verify relevance sorting
5. Test real-time updates when sessions change
6. Join session from discovery results
7. Test location permission handling

### Test Scenarios

- Location-based discovery with permissions
- Search and filter combinations
- Real-time session availability updates
- Advanced session configuration
- Performance with large number of sessions
- Edge cases (no results, permission denied)

## Dev Notes

### File Structure Impact

New files to be created:
- backend/src/services/discoveryService.ts
- backend/src/routes/discovery.ts
- frontend/src/screens/SessionDiscoveryScreen.tsx
- frontend/src/components/SessionFilters.tsx
- frontend/src/services/discoveryApi.ts

Modified files:
- backend/prisma/schema.prisma
- backend/src/models/Session.ts
- backend/src/routes/sessions.ts
- frontend/src/navigation/AppNavigator.tsx
- frontend/src/screens/CreateSessionScreen.tsx

### Extended Session Model

```prisma
model Session {
  // ... existing fields
  latitude      Float?
  longitude     Float?
  skillLevel    String?     // beginner, intermediate, advanced
  courtType     String?     // indoor, outdoor
  visibility    String      @default("public") // public, private
  maxDuration   Int?        // minutes
  isRecurring   Boolean     @default(false)
  recurrencePattern String?
}
```

### Discovery API Contract

```typescript
GET /api/sessions/discovery
Query Parameters:
- latitude: number
- longitude: number
- radius: number (km)
- startTime: ISO string
- endTime: ISO string
- skillLevel: string
- minPlayers: number
- maxPlayers: number
- courtType: string

Response:
{
  sessions: [
    {
      id: string,
      name: string,
      location: string,
      distance: number,
      startTime: string,
      currentPlayers: number,
      maxPlayers: number,
      skillLevel: string,
      organizerName: string
    }
  ],
  totalCount: number,
  searchRadius: number
}
```

### Search Ranking Algorithm

**Relevance Score Factors:**
- Distance: 40% (closer = higher score)
- Time match: 30% (sooner = higher score)
- Skill level match: 20% (exact match = highest)
- Availability: 10% (fewer players = higher priority)

### Real-time Events

```typescript
// New session created
socket.emit('session_discovered', {
  sessionId: string,
  sessionData: object
});

// Session updated
socket.emit('session_updated', {
  sessionId: string,
  changes: object
});

// Session ended
socket.emit('session_removed', {
  sessionId: string
});
```

## Definition of Done

- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Risk Assessment

**Minimal Risk Assessment:**

- **Primary Risk:** Location permissions and privacy concerns
- **Mitigation:** Clear permission requests, optional location features
- **Rollback:** Discovery features can be disabled via feature flags

**Compatibility Verification:**

- [ ] No breaking changes to existing session APIs
- [ ] Discovery is optional (existing link sharing still works)
- [ ] Performance impact acceptable for mobile devices
- [ ] Backward compatibility maintained