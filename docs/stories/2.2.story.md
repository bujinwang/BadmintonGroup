# Story 2.2: Player Status Management - Brownfield Addition

## Status: Done

## Story

As a player,
I want to request "rest" (歇一下) or "leave" (离场) during a session,
So that I can manage my participation and maintain fairness for the group.

## Context Source

- Source Document: docs/prd.md (Phase 2 player status management requirements)
- Enhancement Type: Player experience and session flow feature
- Existing System Impact: Adds status controls to existing player management system

## Acceptance Criteria

**Functional Requirements:**

1. **Rest Request**: Players can request 15-minute rest period (歇一下) with organizer approval
2. **Leave Request**: Players can request permanent departure (离场) with organizer approval
3. **Status Display**: Current player status clearly shown in session view (active, resting, left)
4. **Approval Workflow**: Organizer receives and can approve/deny status change requests
5. **Automatic Rest End**: Rest periods automatically expire after 15 minutes
6. **Status Persistence**: Player status maintained across app restarts and device changes
7. **Status History**: Record of status changes for transparency

**Integration Requirements:**

8. **Real-time Updates**: Status changes immediately reflected across all devices
9. **Pairing Integration**: Resting/leaving players excluded from active pairing
10. **Permission Integration**: Status change requests respect permission system
11. **Database Integration**: Status stored in existing player model

**Quality Requirements:**

12. **Request Validation**: Prevent duplicate or conflicting status requests
13. **Error Handling**: Clear feedback for failed status changes
14. **Performance**: Status updates processed within 1 second
15. **Test Coverage**: Unit tests for status logic, integration tests for workflows
16. **User Feedback**: Clear confirmation and status indicators

**Non-Functional Requirements:**

17. **Usability**: Status change process takes less than 30 seconds
18. **Reliability**: Status changes succeed 99% of the time under normal conditions
19. **Accessibility**: Status controls and feedback accessible to all users
20. **Scalability**: Status system supports up to 20 players per session

## Dev Technical Guidance

### Existing System Context

Current system has player management from Epic 1. Existing patterns include real-time updates and approval workflows.

### Integration Approach

Extend player model with status field, add status change API endpoints, update real-time events, modify pairing logic to exclude inactive players.

### Technical Constraints

- Rest duration fixed at 15 minutes
- Status changes require organizer approval
- Real-time updates mandatory
- Status must integrate with pairing algorithm

### Missing Information

- Exact status workflow steps
- UI indicators for different statuses
- Notification preferences
- Status change conflict resolution

### Tasks / Subtasks

- [ ] Task 1: Extend player model for status
  - [ ] Add status field to player model
  - [ ] Add status change tracking fields
  - [ ] Update Prisma schema
  - [ ] Create database migration

- [ ] Task 2: Implement status change API
  - [ ] Create POST /api/players/{id}/status endpoint
  - [ ] Implement request validation
  - [ ] Add organizer approval logic
  - [ ] Handle automatic rest expiration

- [ ] Task 3: Add approval workflow
  - [ ] Create approval request API
  - [ ] Add approval/denial endpoints
  - [ ] Implement notification system
  - [ ] Add request queue management

- [ ] Task 4: Update frontend status display
  - [ ] Add status indicators to player list
  - [ ] Update player cards with status badges
  - [ ] Add status change request buttons
  - [ ] Implement status-based UI filtering

- [ ] Task 5: Implement real-time status updates
  - [ ] Add status change socket events
  - [ ] Update real-time player list
  - [ ] Handle status conflicts
  - [ ] Test cross-device synchronization

- [ ] Task 6: Integrate with pairing system
  - [ ] Modify pairing algorithm to exclude resting players
  - [ ] Handle leaving players appropriately
  - [ ] Update pairing UI for status changes
  - [ ] Test pairing with various status combinations

- [ ] Task 7: Add comprehensive testing
  - [ ] Unit tests for status logic
  - [ ] Integration tests for approval workflow
  - [ ] UI tests for status indicators
  - [ ] End-to-end tests for complete flow

## Testing

### Validation Steps

1. Join session as player
2. Request rest status (verify approval required)
3. Organizer approves rest request
4. Verify status change in real-time
5. Test automatic rest expiration
6. Request leave status
7. Verify exclusion from pairing
8. Test status persistence

### Test Scenarios

- Valid rest request and approval
- Rest expiration and automatic reactivation
- Leave request and permanent exclusion
- Multiple status requests handling
- Real-time status synchronization
- Status integration with pairing

## Dev Notes

### File Structure Impact

New files to be created:
- backend/src/services/statusService.ts
- backend/src/routes/playerStatus.ts
- frontend/src/components/StatusRequestModal.tsx
- frontend/src/components/PlayerStatusBadge.tsx
- frontend/src/hooks/usePlayerStatus.ts

Modified files:
- backend/prisma/schema.prisma
- backend/src/models/Player.ts
- backend/src/routes/players.ts
- frontend/src/components/PlayerList.tsx
- frontend/src/contexts/SessionContext.tsx

### Status Definitions

```typescript
enum PlayerStatus {
  ACTIVE = 'active',      // Normal playing status
  RESTING = 'resting',    // Temporary rest (15 min)
  LEFT = 'left'          // Permanently left session
}
```

### API Contracts

Request Status Change:
```json
POST /api/players/{id}/status
{
  "action": "rest" | "leave",
  "reason": "string (optional)"
}
```

Response:
```json
{
  "success": true,
  "status": "pending_approval",
  "requestId": "string"
}
```

Approval Response:
```json
{
  "success": true,
  "newStatus": "resting",
  "expiresAt": "ISO timestamp"
}
```

### Status Workflow

1. Player requests status change
2. System creates approval request
3. Organizer receives notification
4. Organizer approves/denies
5. Status updated and broadcast
6. UI updated across all devices

### Real-time Events

```typescript
// Status change request
socket.emit('status_request', {
  playerId: 'string',
  action: 'rest' | 'leave',
  reason: 'string'
});

// Status approved
socket.emit('status_approved', {
  playerId: 'string',
  newStatus: 'resting',
  expiresAt: 'timestamp'
});

// Status expired
socket.emit('status_expired', {
  playerId: 'string',
  newStatus: 'active'
});
```

## Definition of Done

- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Risk Assessment

**Minimal Risk Assessment:**

- **Primary Risk:** Status changes could disrupt ongoing games
- **Mitigation:** Require organizer approval, add confirmation dialogs
- **Rollback:** Status features can be disabled via feature flags

**Compatibility Verification:**

- [ ] No breaking changes to existing player data
- [ ] Real-time events are backward compatible
- [ ] UI gracefully handles missing status features
- [ ] Database migration is safe